<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mannschaftsfahrt - Zahlungstracking</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f5f5f5;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      h1 {
        margin-bottom: 30px;
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }

      .total-section {
        background: #ecf0f1;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 30px;
      }

      .total-section label {
        display: block;
        font-weight: bold;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .total-section input {
        width: 200px;
        padding: 10px;
        font-size: 18px;
        border: 2px solid #bdc3c7;
        border-radius: 4px;
        transition: border-color 0.3s;
      }

      .total-section input:focus {
        outline: none;
        border-color: #3498db;
      }

      .players-section {
        margin-top: 30px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .section-header h2 {
        color: #2c3e50;
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      button:hover {
        background: #2980b9;
      }

      button.remove-btn {
        background: #e74c3c;
        padding: 5px 10px;
        font-size: 12px;
      }

      button.remove-btn:hover {
        background: #c0392b;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th {
        background: #34495e;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #ecf0f1;
      }

      tr:hover {
        background: #f8f9fa;
      }

      input[type='text'],
      input[type='number'] {
        width: 100%;
        padding: 8px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 14px;
      }

      input[type='text']:focus,
      input[type='number']:focus {
        outline: none;
        border-color: #3498db;
      }

      .status-cell {
        font-weight: bold;
        text-align: center;
      }

      .status-paid {
        background: #d4edda;
        color: #155724;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-overpaid {
        background: #f8d7da;
        color: #721c24;
      }

      .summary {
        margin-top: 30px;
        padding: 20px;
        background: #e8f5e9;
        border-radius: 6px;
        border-left: 4px solid #4caf50;
      }

      .summary h3 {
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 16px;
      }

      .summary-total {
        font-weight: bold;
        font-size: 18px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 2px solid #4caf50;
      }

      .export-section {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 2px dashed #bdc3c7;
      }

      .export-section h3 {
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .export-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      button.export-btn {
        background: #27ae60;
      }

      button.export-btn:hover {
        background: #229954;
      }

      button.import-btn {
        background: #9b59b6;
      }

      button.import-btn:hover {
        background: #8e44ad;
      }

      .save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        z-index: 1000;
      }

      .save-indicator.show {
        opacity: 1;
      }

      #fileInput {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üèîÔ∏è Mannschaftsfahrt - Zahlungstracking</h1>

      <div class="total-section">
        <label for="totalAmount">Gesamtbetrag (‚Ç¨):</label>
        <input type="number" id="totalAmount" step="0.01" min="0" placeholder="0.00" value="0" />
      </div>

      <div class="players-section">
        <div class="section-header">
          <h2>Spielerliste</h2>
          <button onclick="addPlayer()">+ Spieler hinzuf√ºgen</button>
        </div>

        <table id="playersTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Gezahlter Betrag (‚Ç¨)</th>
              <th>Restbetrag (‚Ç¨)</th>
              <th>Status</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="playersBody">
            <!-- Spieler werden hier dynamisch eingef√ºgt -->
          </tbody>
        </table>
      </div>

      <div class="summary" id="summary">
        <h3>Zusammenfassung</h3>
        <div class="summary-item">
          <span>Anzahl Spieler:</span>
          <span id="playerCount">0</span>
        </div>
        <div class="summary-item">
          <span>Gesamtbetrag:</span>
          <span id="summaryTotal">0,00 ‚Ç¨</span>
        </div>
        <div class="summary-item">
          <span>Bereits gezahlt:</span>
          <span id="summaryPaid">0,00 ‚Ç¨</span>
        </div>
        <div class="summary-item">
          <span>Noch offen:</span>
          <span id="summaryPending">0,00 ‚Ç¨</span>
        </div>
        <div class="summary-item summary-total">
          <span>Erwarteter Gesamtbetrag:</span>
          <span id="summaryExpected">0,00 ‚Ç¨</span>
        </div>
      </div>

      <div class="export-section">
        <h3>Daten speichern & exportieren</h3>
        <p style="margin-bottom: 15px; color: #7f8c8d; font-size: 14px">
          üíæ Daten werden automatisch im Browser gespeichert. Du kannst sie auch als Datei exportieren oder importieren.
        </p>
        <div class="export-buttons">
          <button class="export-btn" onclick="exportToCSV()">üìä Als CSV exportieren</button>
          <button class="export-btn" onclick="exportToJSON()">üíæ Als JSON exportieren</button>
          <button class="import-btn" onclick="document.getElementById('fileInput').click()">
            üì• Daten importieren
          </button>
          <input type="file" id="fileInput" accept=".json" onchange="importFromJSON(event)" />
        </div>
      </div>
    </div>

    <div class="save-indicator" id="saveIndicator">‚úì Gespeichert</div>

    <script>
      const STORAGE_KEY = 'mannschaftsfahrt_zahlungen'
      const SAVE_DELAY = 1500 // 1.5 Sekunden Pause vor dem Speichern
      let playerIdCounter = 0
      let isInitializing = true
      let saveTimeout = null

      // Gesamtbetrag-Input Event Listener
      document.getElementById('totalAmount').addEventListener('input', () => {
        updateAllStatuses()
        debouncedSave()
      })

      // Debounced Save - wartet auf Pause in der Eingabe
      function debouncedSave() {
        // Nicht speichern w√§hrend der Initialisierung
        if (isInitializing) return

        // Vorherigen Timer l√∂schen
        if (saveTimeout) {
          clearTimeout(saveTimeout)
        }

        // Neuen Timer setzen
        saveTimeout = setTimeout(() => {
          saveData()
        }, SAVE_DELAY)
      }

      // Sofortiges Speichern (f√ºr wichtige Aktionen)
      function saveDataImmediately() {
        if (isInitializing) return

        // Timer l√∂schen falls vorhanden
        if (saveTimeout) {
          clearTimeout(saveTimeout)
          saveTimeout = null
        }

        saveData()
      }

      // Daten speichern (interne Funktion)
      function saveData() {
        // Nicht speichern w√§hrend der Initialisierung
        if (isInitializing) return

        const totalAmount = document.getElementById('totalAmount').value
        const players = []

        document.querySelectorAll('tr[data-player-id]').forEach((row) => {
          const name = row.querySelector('.player-name').value
          const paidAmount = row.querySelector('.paid-amount').value
          if (name.trim() || paidAmount) {
            players.push({ name, paidAmount })
          }
        })

        const data = {
          totalAmount,
          players,
          lastSaved: new Date().toISOString(),
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
        showSaveIndicator()
      }

      // Daten laden
      function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY)

        if (saved) {
          try {
            const data = JSON.parse(saved)

            // Gesamtbetrag laden
            if (data.totalAmount) {
              document.getElementById('totalAmount').value = data.totalAmount
            }

            // Spielerliste leeren
            document.getElementById('playersBody').innerHTML = ''
            playerIdCounter = 0

            // Spieler laden
            if (data.players && data.players.length > 0) {
              data.players.forEach((player) => {
                addPlayer(player.name || '', player.paidAmount || '')
              })
            } else {
              addPlayer()
            }

            updateAllStatuses()
          } catch (e) {
            console.error('Fehler beim Laden der Daten:', e)
            addPlayer()
          }
        } else {
          // Keine gespeicherten Daten - initialen Spieler hinzuf√ºgen
          addPlayer()
        }

        // Initialisierung abgeschlossen
        setTimeout(() => {
          isInitializing = false
        }, 100)
      }

      // Save-Indikator anzeigen
      function showSaveIndicator() {
        const indicator = document.getElementById('saveIndicator')
        indicator.classList.add('show')
        setTimeout(() => {
          indicator.classList.remove('show')
        }, 2000)
      }

      function addPlayer(name = '', paidAmount = '') {
        const tbody = document.getElementById('playersBody')
        const row = document.createElement('tr')
        const playerId = playerIdCounter++

        row.innerHTML = `
                <td>
                    <input type="text"
                           class="player-name"
                           placeholder="Spielername"
                           value="${name}"
                           oninput="updateStatus(${playerId})">
                </td>
                <td>
                    <input type="number"
                           class="paid-amount"
                           step="0.01"
                           min="0"
                           placeholder="0.00"
                           value="${paidAmount}"
                           oninput="updateStatus(${playerId})">
                </td>
                <td class="remaining-amount" data-player-id="${playerId}">0,00</td>
                <td class="status-cell" data-player-id="${playerId}">-</td>
                <td>
                    <button class="remove-btn" onclick="removePlayer(${playerId})">Entfernen</button>
                </td>
            `

        row.setAttribute('data-player-id', playerId)
        tbody.appendChild(row)
        updateStatus(playerId)
        updateSummary()
        saveDataImmediately() // Wichtige Aktion - sofort speichern
      }

      function removePlayer(playerId) {
        const row = document.querySelector(`tr[data-player-id="${playerId}"]`)
        if (row) {
          row.remove()
          updateSummary()
          saveDataImmediately() // Wichtige Aktion - sofort speichern
        }
      }

      function updateStatus(playerId) {
        const row = document.querySelector(`tr[data-player-id="${playerId}"]`)
        if (!row) return

        const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0
        const paidInput = row.querySelector('.paid-amount')
        const paidAmount = parseFloat(paidInput.value) || 0

        const remainingAmount = totalAmount - paidAmount
        const remainingCell = row.querySelector('.remaining-amount')
        const statusCell = row.querySelector('.status-cell')

        remainingCell.textContent = remainingAmount.toFixed(2).replace('.', ',') + ' ‚Ç¨'

        // Status bestimmen
        statusCell.className = 'status-cell'
        if (paidAmount === 0) {
          statusCell.textContent = 'Nicht gezahlt'
          statusCell.classList.add('status-pending')
        } else if (remainingAmount === 0) {
          statusCell.textContent = '‚úì Vollst√§ndig gezahlt'
          statusCell.classList.add('status-paid')
        } else if (remainingAmount > 0) {
          statusCell.textContent = 'Teilweise gezahlt'
          statusCell.classList.add('status-pending')
        } else {
          statusCell.textContent = '√úberzahlung'
          statusCell.classList.add('status-overpaid')
        }

        updateSummary()
        debouncedSave() // Debounced - wartet auf Pause in der Eingabe
      }

      function updateAllStatuses() {
        const rows = document.querySelectorAll('tr[data-player-id]')
        rows.forEach((row) => {
          const playerId = parseInt(row.getAttribute('data-player-id'))
          updateStatus(playerId)
        })
      }

      function updateSummary() {
        const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0
        const rows = document.querySelectorAll('tr[data-player-id]')

        let totalPaid = 0
        let playerCount = 0

        rows.forEach((row) => {
          const nameInput = row.querySelector('.player-name')
          const paidInput = row.querySelector('.paid-amount')

          if (nameInput && nameInput.value.trim() !== '') {
            playerCount++
          }

          const paidAmount = parseFloat(paidInput.value) || 0
          totalPaid += paidAmount
        })

        const pendingAmount = totalAmount * playerCount - totalPaid
        const expectedTotal = totalAmount * playerCount

        document.getElementById('playerCount').textContent = playerCount
        document.getElementById('summaryTotal').textContent = totalAmount.toFixed(2).replace('.', ',') + ' ‚Ç¨'
        document.getElementById('summaryPaid').textContent = totalPaid.toFixed(2).replace('.', ',') + ' ‚Ç¨'
        document.getElementById('summaryPending').textContent = pendingAmount.toFixed(2).replace('.', ',') + ' ‚Ç¨'
        document.getElementById('summaryExpected').textContent = expectedTotal.toFixed(2).replace('.', ',') + ' ‚Ç¨'
      }

      // Export als CSV
      function exportToCSV() {
        const totalAmount = document.getElementById('totalAmount').value || '0'
        const rows = document.querySelectorAll('tr[data-player-id]')

        let csv = 'Name,Gezahlter Betrag (‚Ç¨),Restbetrag (‚Ç¨),Status\n'

        rows.forEach((row) => {
          const name = row.querySelector('.player-name').value || ''
          const paidAmount = row.querySelector('.paid-amount').value || '0'
          const remainingCell = row.querySelector('.remaining-amount')
          const statusCell = row.querySelector('.status-cell')

          const remaining = remainingCell.textContent.replace(' ‚Ç¨', '').replace(',', '.')
          const status = statusCell.textContent

          csv += `"${name}",${paidAmount},${remaining},"${status}"\n`
        })

        csv += `\nGesamtbetrag pro Spieler,${totalAmount}\n`

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
        const link = document.createElement('a')
        const url = URL.createObjectURL(blob)
        link.setAttribute('href', url)
        link.setAttribute('download', `mannschaftsfahrt-zahlungen-${new Date().toISOString().split('T')[0]}.csv`)
        link.style.visibility = 'hidden'
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
      }

      // Export als JSON
      function exportToJSON() {
        const totalAmount = document.getElementById('totalAmount').value
        const players = []

        document.querySelectorAll('tr[data-player-id]').forEach((row) => {
          const name = row.querySelector('.player-name').value
          const paidAmount = row.querySelector('.paid-amount').value
          const remainingCell = row.querySelector('.remaining-amount')
          const statusCell = row.querySelector('.status-cell')

          if (name.trim() || paidAmount) {
            players.push({
              name: name || '',
              paidAmount: paidAmount || '0',
              remainingAmount: remainingCell.textContent.replace(' ‚Ç¨', '').replace(',', '.'),
              status: statusCell.textContent,
            })
          }
        })

        const data = {
          totalAmount,
          players,
          exportedAt: new Date().toISOString(),
          version: '1.0',
        }

        const json = JSON.stringify(data, null, 2)
        const blob = new Blob([json], { type: 'application/json;charset=utf-8;' })
        const link = document.createElement('a')
        const url = URL.createObjectURL(blob)
        link.setAttribute('href', url)
        link.setAttribute('download', `mannschaftsfahrt-zahlungen-${new Date().toISOString().split('T')[0]}.json`)
        link.style.visibility = 'hidden'
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
      }

      // Import von JSON
      function importFromJSON(event) {
        const file = event.target.files[0]
        if (!file) return

        const reader = new FileReader()
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result)

            // Gesamtbetrag laden
            if (data.totalAmount) {
              document.getElementById('totalAmount').value = data.totalAmount
            }

            // Spielerliste leeren
            document.getElementById('playersBody').innerHTML = ''
            playerIdCounter = 0

            // Spieler laden
            if (data.players && data.players.length > 0) {
              data.players.forEach((player) => {
                addPlayer(player.name || '', player.paidAmount || '')
              })
            } else {
              addPlayer()
            }

            updateAllStatuses()
            saveDataImmediately() // Wichtige Aktion - sofort speichern

            alert('Daten erfolgreich importiert!')
          } catch (error) {
            alert('Fehler beim Importieren der Datei. Bitte stelle sicher, dass es eine g√ºltige JSON-Datei ist.')
            console.error('Import-Fehler:', error)
          }
        }
        reader.readAsText(file)

        // Input zur√ºcksetzen, damit derselbe Datei wieder importiert werden kann
        event.target.value = ''
      }

      // Beim Laden der Seite Daten laden
      window.addEventListener('DOMContentLoaded', () => {
        loadData()
      })

      // Beim Schlie√üen der Seite sofort speichern (falls noch nicht gespeichert)
      window.addEventListener('beforeunload', () => {
        if (saveTimeout) {
          clearTimeout(saveTimeout)
        }
        saveData()
      })
    </script>
  </body>
</html>
